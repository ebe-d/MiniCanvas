# MiniCanvas Deployment Guide - Render

This guide provides step-by-step instructions for deploying the MiniCanvas application (HTTP Backend, WebSocket Backend, and Frontend) to Render.

## üöÄ Quick Deployment Overview

MiniCanvas consists of:
- **HTTP Backend**: REST API for authentication, rooms, and user management
- **WebSocket Backend**: Real-time collaboration for drawing
- **Frontend**: Next.js application with canvas drawing interface
- **Database**: PostgreSQL for data persistence

## üìã Prerequisites

- Render account (https://render.com)
- GitHub repository with this codebase
- Basic understanding of Render services

## üóÑÔ∏è Step 1: Database Setup

### Using Existing Neon Database

Since you already have a Neon database set up:

1. **Get Your Neon Connection String**
   - Go to your Neon dashboard
   - Copy the connection string from your database
   - Format: `postgresql://user:password@host:port/database`

2. **Note the Connection Details**
   - You'll use this connection string for both backend services
   - Make sure your Neon database allows connections from Render's IP ranges

## üîß Step 2: Deploy Services

### Method 1: Using Render Blueprint (Recommended)

1. **Connect GitHub Repository**
   - Go to https://dashboard.render.com
   - Click "New" ‚Üí "Blueprint"
   - Connect your GitHub account
   - Select the repository containing this codebase

2. **Deploy Blueprint**
   - Render will detect the `render.yaml` file
   - Click "Deploy Blueprint"
   - This creates the 3 services automatically

3. **Manual Environment Setup** (Required)
   - After services are created, you'll need to manually set environment variables
   - Follow Step 3 below for detailed instructions

### Method 2: Manual Service Creation

If blueprint deployment doesn't work, create services manually:

#### 2.1 Create HTTP Backend Service

1. **Create Web Service**
   - Click "New" ‚Üí "Web Service"
   - Connect your GitHub repository
   - Name: `minicanvas-http-backend`
   - Environment: `Node`
   - Build Command: `cd apps/http-backend && npm install && npm run build`
   - Start Command: `cd apps/http-backend && npm start`

2. **Environment Variables**
   ```
   NODE_ENV=production
   JWT_SECRET=<generate-random-secret>
   DATABASE_URL=<postgresql-connection-string>
   PORT=10000
   ```

#### 2.2 Create WebSocket Backend Service

1. **Create Web Service**
   - Click "New" ‚Üí "Web Service"
   - Connect your GitHub repository
   - Name: `minicanvas-ws-backend`
   - Environment: `Node`
   - Build Command: `cd apps/ws-backend && npm install && npm run build`
   - Start Command: `cd apps/ws-backend && npm start`

2. **Environment Variables**
   ```
   NODE_ENV=production
   JWT_SECRET=<same-as-http-backend>
   DATABASE_URL=<postgresql-connection-string>
   PORT=10000
   ```

#### 2.3 Create Frontend Service

1. **Create Web Service**
   - Click "New" ‚Üí "Web Service"
   - Connect your GitHub repository
   - Name: `minicanvas-frontend`
   - Environment: `Node`
   - Build Command: `cd apps/minicanvas-fe && npm install && npm run build`
   - Start Command: `cd apps/minicanvas-fe && npm start`

2. **Environment Variables**
   ```
   NODE_ENV=production
   HTTP_BACKEND_URL=<http-backend-service-url>
   WS_BACKEND_URL=<ws-backend-service-url>
   ```

## üîó Step 3: Configure Environment Variables

### For All Methods (Required)

After services are created, you need to manually configure environment variables:

#### 1. HTTP Backend Environment Variables
Go to your HTTP backend service ‚Üí Environment ‚Üí Add Environment Variable:

```env
DATABASE_URL=postgresql://your-db-connection-string
```

**Note**: JWT_SECRET is auto-generated by Render

#### 2. WebSocket Backend Environment Variables
Go to your WebSocket backend service ‚Üí Environment ‚Üí Add Environment Variable:

```env
DATABASE_URL=postgresql://your-db-connection-string
JWT_SECRET=copy-from-http-backend-service
```

#### 3. Frontend Environment Variables
Go to your frontend service ‚Üí Environment ‚Üí Add Environment Variable:

```env
HTTP_BACKEND_URL=https://your-http-backend-service.onrender.com
WS_BACKEND_URL=https://your-ws-backend-service.onrender.com
```

### How to Find Service URLs

1. **Go to Render Dashboard**
2. **Click on each service**
3. **Copy the service URL** from the top (e.g., `https://minicanvas-http-backend.onrender.com`)

### How to Find JWT_SECRET

1. **Go to HTTP Backend service**
2. **Click "Environment" tab**
3. **Copy the JWT_SECRET value** (auto-generated)
4. **Paste it into WebSocket backend** environment variables

## üóÉÔ∏è Step 4: Database Migration

### Run Prisma Migrations

1. **Connect to Database**
   ```bash
   # Install Prisma CLI globally (if not already installed)
   npm install -g prisma

   # Set DATABASE_URL environment variable (use your Neon connection string)
   export DATABASE_URL="your-neon-database-connection-string"
   ```

2. **Run Migrations**
   ```bash
   cd packages/db
   npx prisma migrate deploy
   ```

3. **Generate Prisma Client**
   ```bash
   npx prisma generate
   ```

## üîê Step 5: Environment Variables Setup

### Required Environment Variables

#### HTTP Backend (Auto-generated by Render)
```env
NODE_ENV=production
JWT_SECRET=<auto-generated-by-render>
DATABASE_URL=<your-postgresql-connection-string>
PORT=10000
```

#### WebSocket Backend (Manual Setup Required)
```env
NODE_ENV=production
JWT_SECRET=<copy-from-http-backend>
DATABASE_URL=<your-postgresql-connection-string>
PORT=10000
```

#### Frontend (Manual Setup Required)
```env
NODE_ENV=production
HTTP_BACKEND_URL=https://your-http-backend-service.onrender.com
WS_BACKEND_URL=https://your-ws-backend-service.onrender.com
```

### Important Notes

1. **JWT_SECRET**: Render auto-generates this for the HTTP backend. You must copy it to the WebSocket backend manually.

2. **Service URLs**: Use the actual URLs from your deployed services, not the placeholder names.

3. **Database URL**: Use your existing Neon database connection string.

## üöÄ Step 6: Deploy and Test

### Deploy Services
1. **Deploy HTTP Backend First**
   - This ensures the API is available for the frontend

2. **Deploy WebSocket Backend**
   - Real-time collaboration backend

3. **Deploy Frontend Last**
   - Depends on both backend services

### Test Deployment
1. **Visit Frontend URL**
   - Should load the MiniCanvas homepage

2. **Test Authentication**
   - Try signing up a new user
   - Try signing in

3. **Test Canvas**
   - Create a room
   - Test drawing functionality
   - Test real-time collaboration

## üîç Troubleshooting

### Common Issues

#### 1. Build Failures
```bash
# Check build logs in Render dashboard
# Common issues:
# - Missing dependencies in package.json
# - TypeScript compilation errors
# - Prisma client not generated
```

#### 2. Database Connection Issues
```bash
# Verify DATABASE_URL format (should be your Neon connection string)
# Ensure Neon database allows connections from Render's IP ranges
# Check Neon dashboard for connection limits and settings
# Verify DATABASE_URL is set correctly in both backend services
```

#### 3. WebSocket Connection Issues
```bash
# Verify WS_BACKEND_URL format (should be wss:// for production)
# Check CORS settings in backend
# Ensure JWT_SECRET is identical across services
```

#### 4. Frontend API Calls Failing
```bash
# Verify HTTP_BACKEND_URL format (should be https:// for production)
# Check if backend service is running
# Verify environment variables are set correctly
```

### Debug Commands

#### Check Service Health
```bash
# HTTP Backend health check
curl https://your-http-backend-url.onrender.com

# WebSocket connection test
# Use browser developer tools Network tab
```

#### View Logs
- Go to Render Dashboard
- Select your service
- Click "Logs" tab
- Check for error messages

## üí∞ Cost Estimation

### Render Pricing (as of 2025)
- **Web Services**: $7/month each (Starter plan)
- **Total**: ~$21/month for 3 services
- **Database**: Already covered by Neon (your existing setup)

### Free Tier Limitations
- Services sleep after 15 minutes of inactivity
- 750 hours/month free
- May experience cold starts

### Your Setup
- **HTTP Backend**: $7/month
- **WebSocket Backend**: $7/month
- **Frontend**: $7/month
- **Database**: Covered by Neon (no additional cost)

## üîÑ Updates and Maintenance

### Deploying Updates
1. **Push to GitHub**
   - Render automatically redeploys on git push

2. **Manual Deploy**
   - Go to Render Dashboard
   - Click "Manual Deploy" ‚Üí "Deploy latest commit"

### Database Updates
```bash
# When schema changes:
cd packages/db
npx prisma migrate dev --name your-migration-name
npx prisma generate

# Deploy to production:
npx prisma migrate deploy
```

## üìä Monitoring

### Render Dashboard
- **Service Status**: Check if services are running
- **Logs**: Monitor for errors and performance issues
- **Metrics**: CPU, memory, and request counts

### Application Monitoring
- **User Registration**: Monitor signup/signin success rates
- **Room Creation**: Track room creation metrics
- **WebSocket Connections**: Monitor real-time connection health

## üéØ Production Checklist

- [ ] All services deployed and running
- [ ] Database migrations applied
- [ ] Environment variables configured
- [ ] JWT secrets generated and consistent
- [ ] Frontend can connect to backends
- [ ] Authentication working
- [ ] Canvas drawing functional
- [ ] Real-time collaboration working
- [ ] Mobile responsiveness tested
- [ ] Error handling verified

## üìû Support

If you encounter issues:
1. Check Render service logs
2. Verify environment variables
3. Test API endpoints manually
4. Check database connectivity
5. Review this deployment guide

## üöÄ Success!

Once deployed, your MiniCanvas application will be available at:
- **Frontend**: `https://minicanvas-frontend.onrender.com`
- **HTTP API**: `https://minicanvas-http-backend.onrender.com`
- **WebSocket**: `https://minicanvas-ws-backend.onrender.com`

Users can now:
- Sign up and sign in
- Create collaborative drawing rooms
- Draw in real-time with other users
- Use all canvas tools and features

üé® Happy drawing!